name: Sync Folders to Branches

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config --global user.name 'Hexcss'
          git config --global user.email 'cadersuay.javier@gmail.com'

      - name: Push subtree splits
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          REMOTE="https://x-access-token:${TOKEN}@github.com/${REPO}.git"

          folders=("frontend" "backend/api" "backend/gateway")
          for folder in "${folders[@]}"; do
            echo "==> Splitting '$folder'"
            # Create a temp branch at the split commit
            git subtree split --prefix="$folder" -b split-tmp
            COMMIT=$(git rev-parse split-tmp)
            echo "    split at $COMMIT"

            echo "    pushing to remote branch '$folder'"
            git push "$REMOTE" "split-tmp:$folder" --force

            git branch -D split-tmp
          done
